<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Page</title>
  <link rel="icon" href="/images/binar-logos-text.png" sizes="128x128" type="image/gif/png">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css">
  <link rel="stylesheet" href="/style/guest.css">
</head>
<body>
  <div class="container-fluid">
    <!-- navbar -->
    <nav class="navbar navbar-expand-lg navbar-light" style="background-color:rgb(255, 167, 52)">
      
      <a class="navbar-brand" href="#">
        <img src="/images/binar-logos-notext.png" width="30" height="30" class="d-inline-block align-top" alt="">
        NodeJS
      </a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
        
        </ul>

        <form class="form-inline my-2 my-lg-0">
          <button id="btnLogout" type="button" class="btn btn-outline-dark my-2 my-sm-0">Logout</button>
        </form>

      </div>
    </nav>      
    <!-- navbar -->

    <!-- row alert -->
    <div id="row-alert" class="alert alert-success alert-dismissible show my-3" role="alert">

    </div>
    <!-- row alert -->

    <!-- start navigation -->
    <div class="wrapper-navigation d-flex my-3">
        <div class="navigation-add col-md-4 p-0">
          <form class="form-inline">
            <button type="button" name="btnAdd" id="btnAdd" class="btn btn-md btn-outline-primary mr-4">
              <i class="fa fa-cart-plus"></i>
            </button>                      
          </form>
        </div>
        <div class="navigation-search col-md-4 p-0">
          <form class="form-inline justify-content-center">
            <div class="input-group">
              <div class="input-group-prepend">
                <span class="input-group-text" id="inputGroupPrepend"><i class="fa fa-question-circle"></i></span>
              </div>
              <input type="text" class="form-control search mr-2" id="search" name="search" placeholder="Search Product Here.." style="width:25%;">
            </div>            
            <button type="button" name="btnSearch" id="btnSearch" class="btn btn-md btn-outline-success mr-2">
              <i class="fa fa-search"></i>
            </button>              
            <button type="button" name="btnReset" id="btnReset" class="btn btn-md btn-outline-secondary mr-2">
              <i class="fa fa-broom"></i>
            </button>               
            <button type="button" name="btnRefresh" id="btnRefresh" class="btn btn-md btn-outline-info">
              <i class="fa fa-sync"></i>
            </button>            
          </form>
        </div>
        <div class="pagination col-md-4 justify-content-end p-0">
          <ul class="pagination pagination-list pagination-md m-0 p-0">
            <li class="page-item"><a class="page-link" href="#">Previous</a></li>
            <li class="page-item"><a class="page-link" href="#">1</a></li>
            <li class="page-item"><a class="page-link" href="#">2</a></li>
            <li class="page-item"><a class="page-link" href="#">Next</a></li>
          </ul>    
        </div>     


    </div>
    <!-- end navigation -->    

    <!-- row table-product -->
    <div class="wrapper-table-product table-responsive my-3" style="overflow:auto; height:550px;">
        <table class="table table-bordered table-hover table-light mb-0">
          <thead class="thead-light">
            <tr>
              <th scope="col" class="text-center" style="width: 5%;">#</th>
              <th scope="col" class="text-center" style="width: 10%;">Name</th>
              <th scope="col" class="text-center" style="width: 10%;">Price</th>
              <th scope="col" class="text-center">Description</th>
              <th scope="col" class="text-center" style="width: 10%;">Owner</th>
              <th scope="col" class="text-center" style="width: 10%;">Stock</th>
              <th scope="col" class="text-center" style="width: 10%;">Action</th>
            </tr>            
          </thead>
          <tbody class="table-body" id="table-body">
                            
          </tbody>
        </table>      
    </div>
    <!-- row table-product -->
    <!-- row modal hidden --> 
    <div class="wrapper-modal">
      <!-- Modal -->
      <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Warning!!</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              You're about to delete the data. Are you sure you want to delete it?
            </div>
            <div class="modal-footer">

            </div>
          </div>
        </div>
      </div>      
    </div>
    <!-- row modal hidden -->
  </div>
</body>
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF" crossorigin="anonymous"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>
<script src="https://pro.fontawesome.com/releases/v5.10.0/js/all.js" integrity="sha384-G/ZR3ntz68JZrH4pfPJyRbjW+c0+ojii5f+GYiYwldYU69A+Ejat6yIfLSxljXxD" crossorigin="anonymous"></script>
<script type="text/javascript">
/* set Cookie */
function setCookie(name,value,days) {
  var expires = "";
  if (days) {
    var date = new Date();
    date.setTime(date.getTime() + (days*24*60*60*1000));
    expires = "; expires=" + date.toUTCString();
  }
  document.cookie = name + "=" + (value || "")  + expires + "; path=/";
}

/* get Cookie */
function getCookies(name) {
  var nameEQ = name + "=";
  var ca = document.cookie.split(';');
  for(var i=0;i < ca.length;i++) {
      var c = ca[i];
      while (c.charAt(0)==' ') c = c.substring(1,c.length);
      if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
  }
  return null;
}

/* btnLogout - back to Login Page */
document.querySelector("#btnLogout").addEventListener('click', (event) => {
  setCookie('user-data', null, Date.now());  
  location.href = '/homepage';
})

/* btnAdd - new form */
document.querySelector("#btnAdd").addEventListener('click', (event) => {
  // kalo cookies di-delete
  if( getCookies('user-data') == null || getCookies('user-data') == undefined) {
    alert('Silahkan Login Terlebih Dahulu');    
    location.href = '/homepage';
  } else {
    location.href = '/add-data';
  }
})

/* button RESET di Navigation */
document.querySelector('#btnReset').addEventListener('click', () => {
  document.querySelector('#search').value = '';
})

/* button REFRESH di Navigation */
document.querySelector('#btnRefresh').addEventListener('click', () => {
  // kalo cookies di-delete
  if( getCookies('user-data') == null || getCookies('user-data') == undefined) {
    alert('Silahkan Login Terlebih Dahulu');    
    location.href = '/homepage';
  } else {
    location.href = '/dashboard-user'
  }  

})

/* fetch data to table */
async function getDataTables() {
  const response = await fetch('/list-user-products/'+'awal', {
    method: 'GET', 
    headers: {
      'Content-Type': 'application/json',
      'Owner': JSON.parse(getCookies('user-data')).username,
      // 'Authorization': 'Bearer '+JSON.parse(getCookies('user-data')).token
    }
  })
  // error handling - throw ke catch error
  if (!response.ok) {
    const message = `An error has occured: ${response.status} & Text : ${response.statusText}`;
    throw new Error(message);
  }
  const result = await response.json();

  return result;
}

getDataTables().then(result => {
  console.log(result);

  /* untuk alert */
  document.querySelector('#row-alert').innerHTML = `
    <b>${ result.message }</b>
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>      
  `;

  /* untuk pagination */
  document.querySelector('.pagination-list').innerHTML = '';
  if(result.result.length > 0) {
    parseInt(result.current) == 1 ? document.querySelector('.pagination-list').innerHTML += `<li class="page-item disabled"><a class="page-link">First</a></li>` : document.querySelector('.pagination-list').innerHTML += `<li class="page-item"><a class="page-link" onclick="fetchTableUser(1);return false;">First</a></li>`;
    let i = (parseInt(result.current) > 5 ? parseInt(result.current) - 4 : 1)
    if (i !== 1) {
      document.querySelector('.pagination-list').innerHTML += `<li class="page-item disabled"><a class="page-link">...</a></li>`;
    }
    for (; i <= (parseInt(result.current) + 4) && i <= result.pages; i++) {  
      if (i == 0) {
        document.querySelector('.pagination-list').innerHTML += `<li class="page-item active"><a class="page-link">${ i }</a></li>`;
      } else {
        document.querySelector('.pagination-list').innerHTML += `<li class="page-item"><a class="page-link" onclick="fetchTableUser('${ i }');return false;">${ i }</a></li>`;
      }
    }
    if (parseInt(result.current) == result.pages) {
      document.querySelector('.pagination-list').innerHTML += `<li class="page-item disabled"><a class="page-link">Last</a></li>`;
    } else {
      document.querySelector('.pagination-list').innerHTML += `        
        <li class="page-item">
          <a class="page-link" onclick="fetchTableUser(${ result.pages });return false;">Last</a>
        </li>  `;
    }
  }

  /* untuk isi table */
  document.querySelector('#table-body').innerHTML = '';

  for( let i=0; i < result.result.length; i++ ) {
    document.querySelector('#table-body').innerHTML += `
      <tr>
          <td scope="col" class="text-center">${ i+1 }</td>
          <td scope="col" class="text-center"><i>${ result.result[i].name }</i></td>
          <td scope="col" class="text-center">${ Number(result.result[i].price).toLocaleString('id-ID') }</td>
          <td scope="col" class="text-center"><p class="text-justify text-wrap font-italic">${ result.result[i].desc }</p></td>
          <td scope="col" class="text-center">${ result.result[i].owner }</td>
          ${ result.result[i].quantity > 0 ? `<td scope="col" class="text-center"><span class="badge badge-pill badge-success">Available</span></td>` : `<td scope="col" class="text-center"><span class="badge badge-pill badge-danger">Out of Stock</span></td>` }
          <td scope="col" class="text-center">
            <button type="button" name="btnDetail" id="btnDetail" class="btn btnDetail btn-sm btn-outline-primary" data-toggle="modal" data-target="#exampleModal" data-action="popup" data-path="${ result.result[i].filePath }" data-price="${ result.result[i].price }" data-name="${ result.result[i].name }" data-whatever="${ result.result[i]._id }"><i class="fa fa-images"></i></button>
            <a class="btn btn-sm btn-outline-success" name="btnEdit" id="btnEdit" href="/find-data/${ result.result[i].id }" role="button"><i class="fa fa-pencil"></i></a>
            <button type="button" name="btnDelete" id="btnDelete" class="btn btn-sm btn-outline-danger" data-toggle="modal" data-target="#exampleModal" data-name="${ result.result[i].name }" data-whatever="${ result.result[i]._id }"><i class="fa fa-dumpster"></i></button>
          </td>
        </tr>   
    `;
  }
}).catch(error => {
  console.log(error);
})
/* end fetch */

/* search and pop data into tables */
document.querySelector('#btnSearch').addEventListener('click', (event) => {
  // kalo cookies di-delete
  if( getCookies('user-data') == null || getCookies('user-data') == undefined) {
    alert('Silahkan Login Terlebih Dahulu');
    location.href = '/homepage';
  } else {
    if( document.querySelector('#search').value == '' || document.querySelector('#search').value == null ) {
      alert('Masukkan Keyword Pencarian');
    } else {
      fetch('/list-user-products/'+document.querySelector('#search').value, {
        method: 'GET', 
        headers: {
          'Content-Type': 'application/json',
          'Owner': JSON.parse(getCookies('user-data')).username,
          // 'Authorization': 'Bearer '+JSON.parse(getCookies('user-data')).token
        }
      }).then(response => {
        return response.json();
      }).then(result => {
        console.log(result);

        /* untuk alert */
        document.querySelector('#row-alert').innerHTML = `
          <b>${ result.message }</b>
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>      
        `;

        /* untuk pagination */
        document.querySelector('.pagination-list').innerHTML = '';
        if(result.result.length > 0) {
          parseInt(result.current) == 1 ? document.querySelector('.pagination-list').innerHTML += `<li class="page-item disabled"><a class="page-link" id="a-satu">First</a></li>` : `<li class="page-item"><a class="page-link" id="a-satu" onclick="fetchTableUser(1,'${result.search}');">First</a></li>`;
          let i = (parseInt(result.current) > 5 ? parseInt(result.current) - 4 : 1)
          if (i !== 1) {
            document.querySelector('.pagination-list').innerHTML += `<li class="page-item disabled"><a class="page-link">...</a></li>`;
          }
          for (; i <= (parseInt(result.current) + 4) && i <= result.pages; i++) {  
            if (i == 0) {
              document.querySelector('.pagination-list').innerHTML += `<li class="page-item active"><a class="page-link">${ i }</a></li>`;
            } else {
              document.querySelector('.pagination-list').innerHTML += `<li class="page-item"><a class="page-link" onclick="fetchTableUser(${i},'${result.search}');">${ i }</a></li>`;
            }
          }
          if (parseInt(result.current) == result.pages) {
            document.querySelector('.pagination-list').innerHTML += `<li class="page-item disabled"><a class="page-link">Last</a></li>`;
          } else {
            document.querySelector('.pagination-list').innerHTML += `<li class="page-item"><a class="page-link" onclick="fetchTableUser(${result.pages},'${result.search}');">Last</a></li>`;
          }
        }

        /* untuk isi table */
        document.querySelector('#table-body').innerHTML = '';
        for( let i=0; i < result.result.length; i++ ) {
          document.querySelector('#table-body').innerHTML += `
            <tr>
                <td scope="col" class="text-center">${ i+1 }</td>
                <td scope="col" class="text-center"><i>${ result.result[i].name }</i></td>
                <td scope="col" class="text-center">${ Number(result.result[i].price).toLocaleString('id-ID') }</td>
                <td scope="col" class="text-center"><p class="text-justify text-wrap font-italic">${ result.result[i].desc }</p></td>
                <td scope="col" class="text-center">${ result.result[i].owner }</td>
                ${ result.result[i].quantity > 0 ? `<td scope="col" class="text-center"><span class="badge badge-pill badge-success">Available</span></td>` : `<td scope="col" class="text-center"><span class="badge badge-pill badge-danger">Out of Stock</span></td>` }
                <td scope="col" class="text-center">
                  <button type="button" name="btnDetail" id="btnDetail" class="btn btnDetail btn-sm btn-outline-primary" data-toggle="modal" data-target="#exampleModal" data-action="popup" data-path="${ result.result[i].filePath }" data-price="${ result.result[i].price }" data-name="${ result.result[i].name }" data-whatever="${ result.result[i]._id }"><i class="fa fa-images"></i></button>
                  <a class="btn btn-sm btn-outline-success" name="btnEdit" id="btnEdit" href="/find-data/${ result.result[i].id }" role="button"><i class="fa fa-pencil"></i></a>
                  <button type="button" name="btnDelete" id="btnDelete" class="btn btn-sm btn-outline-danger" data-toggle="modal" data-target="#exampleModal" data-name="${ result.result[i].name }" data-whatever="${ result.result[i]._id }"><i class="fa fa-dumpster"></i></button>
                </td>
              </tr>   
          `;
        }
      }).catch(error => {
        console.log(error);
      })
    }    
  }
})

/* fetch isi table - pagination */
async function fetchTableUser(page, search) {
  console.log("Dari FETCH TABLE USER FE : "+page);
  console.log("Dari FETCH TABLE USER FE : "+search);

  const response = await fetch('/fetchTableUser/'+page+'/'+search, {
  // const response = fetch(`/fetchTableUser/${page}/${search}`, {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json', 
      'Owner': JSON.parse(getCookies('user-data')).username,
      // 'Authorization': 'Bearer '+JSON.parse(getCookies('user-data')).token  
    }
  }).then(response => {
    return response.json();
  }).then(result => {
    console.log(result);
    console.log(parseInt(result.current))

    /* untuk pagination */
    document.querySelector('.pagination-list').innerHTML = '';
    if(result.result.length > 0) {
      parseInt(result.current) == 1 ? document.querySelector('.pagination-list').innerHTML += `<li class="page-item disabled"><a class="page-link" id="a-satu">First</a></li>` : document.querySelector('.pagination-list').innerHTML += `<li class="page-item"><a class="page-link" id="a-satu" onclick="fetchTableUser(1,'${result.search}');">First</a></li>`;
      let i = (parseInt(result.current) > 5 ? parseInt(result.current) - 4 : 1)
      if (i !== 1) {
        document.querySelector('.pagination-list').innerHTML += `<li class="page-item disabled"><a class="page-link">...</a></li>`;
      }
      for (; i <= (parseInt(result.current) + 4) && i <= result.pages; i++) {  
        if (i == 0) {
          document.querySelector('.pagination-list').innerHTML += `<li class="page-item active"><a class="page-link">${ i }</a></li>`;
        } else {
          document.querySelector('.pagination-list').innerHTML += `<li class="page-item"><a class="page-link" onclick="fetchTableUser(${i},'${result.search}');">${ i }</a></li>`;
        }
      }
      if (parseInt(result.current) == result.pages) {
        document.querySelector('.pagination-list').innerHTML += `<li class="page-item disabled"><a class="page-link">Last</a></li>`;
      } else {
        document.querySelector('.pagination-list').innerHTML += `<li class="page-item"><a class="page-link" onclick="fetchTableUser(${result.pages},'${result.search}');">Last</a></li>`;
      }
    }    

    /* table */
    document.querySelector('.table-body').innerHTML = '';
    for( let i=0; i < result.result.length; i++ ) {
      document.querySelector('.table-body').innerHTML += `
        <tr>
            <td scope="col" class="text-center">${ i+(Number(result.offset)+1) }</td>
            <td scope="col" class="text-center"><i>${ result.result[i].name }</i></td>
            <td scope="col" class="text-center">${ Number(result.result[i].price).toLocaleString('id-ID') }</td>
            <td scope="col" class="text-center"><p class="text-justify text-wrap font-italic">${ result.result[i].desc }</p></td>
            <td scope="col" class="text-center">${ result.result[i].owner }</td>
            ${ result.result[i].quantity > 0 ? `<td scope="col" class="text-center"><span class="badge badge-pill badge-success">Available</span></td>` : `<td scope="col" class="text-center"><span class="badge badge-pill badge-danger">Out of Stock</span></td>` }
            <td scope="col" class="text-center">
              <button type="button" name="btnDetail" id="btnDetail" class="btn btnDetail btn-sm btn-outline-primary" data-toggle="modal" data-target="#exampleModal" data-action="popup" data-path="${ result.result[i].filePath }" data-price="${ result.result[i].price }" data-name="${ result.result[i].name }" data-whatever="${ result.result[i]._id }"><i class="fa fa-images"></i></button>
              <a class="btn btn-sm btn-outline-success" name="btnEdit" id="btnEdit" href="/find-data/${ result.result[i].id }" role="button"><i class="fa fa-pencil"></i></a>
              <button type="button" name="btnDelete" id="btnDelete" class="btn btn-sm btn-outline-danger" data-toggle="modal" data-target="#exampleModal" data-name="${ result.result[i].name }" data-whatever="${ result.result[i]._id }"><i class="fa fa-dumpster"></i></button>
            </td>
        </tr>   
      `;
    }
  }).catch(error => {
    console.log(error);
  })
}

function redirectEdit(params) {
  if( getCookies('user-data') == null || getCookies('user-data') == undefined) {
    alert('Silahkan Login Terlebih Dahulu');
    location.href = '/homepage';
  } else {
    location.href = `/find-data/${ params }`;
  }
}

/* modal */
$('#exampleModal').on('show.bs.modal', function (event) {
  let button = $(event.relatedTarget) // Button that triggered the modal
  let _id = button.data('whatever') // Extract info from data-* attributes
  
  let name = button.data('name')
  let price = button.data('price')
  let path = button.data('path')
  let action = button.data('action')  
  // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
  // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
  let modal = $(this)
  if( action === 'popup' ) {
    /* title */
    modal.find('.modal-title').text('Image for ' + name)  
    /* body */
    document.querySelector('.modal-body').innerHTML = `
      <img src="../${ path }" alt="image retrieve" width="460" height="300">
      <p class="text-center font-italic mt-1"> Harga : ${ price.toLocaleString('id-ID') } </p>
    `;
    /* footer */
    document.querySelector('.modal-footer').innerHTML = `
      <button type="button" class="btn btn-secondary" data-dismiss="modal">
        <i class="fa fa-times"></i>
        Dismiss
      </button>
    `;    
  } else {
    modal.find('.modal-title').text('Warning! Delete ' + name)

    document.querySelector('.modal-footer').innerHTML = `
      <button type="button" class="btn btn-secondary" data-dismiss="modal">
        <i class="fa fa-thumbs-down"></i>
        Nah, I Change My Mind
      </button>
      <button type="button" id="${ _id }" onclick="deleteData(this.id)" class="btn btn-primary btn-delete">
        <i class="fa fa-thumbs-up"></i>
        Sure, Go Ahead
      </button>
    `;
  }
})

/* remove products - dumpster button */
function deleteData(params) {
  // kalo cookies di-delete
  if( getCookies('user-data') == null || getCookies('user-data') == undefined) {
    alert('Silahkan Login Terlebih Dahulu');
    location.href = '/homepage';
  } else   
      document.querySelector('#exampleModal').style.display = 'none';
      document.querySelector("body").classList.remove("modal-open");

      fetch(`/delete-data/${ params }`, {
        method: 'POST', 
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' +JSON.parse(getCookies('user-data')).token
        }
      })
      .then(function (response) {
        return response.json();
      })
      .then(function (result) {
        console.log(result)

        document.querySelector('#row-alert').innerHTML = `
          <strong>${ result.message }!</strong> Data Dengan ID ${ result.result } terhapus. <strong>Tunggu beberapa saat lagi, Tabel akan me-reload data baru</strong>
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>      
        `;    

        setTimeout(function () {
          location.reload();
        }, 3000)        
      })
      .catch(function(error) {
        console.log(error)
      })
}

</script>
</html>